{% extends "userprofile/layout.html" %}
{% load humanize %}

{% block dashboard_content %}
<div class="row">
  <div class="col-lg-6 mb-4">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <h5 class="card-title">Pay Jobflick</h5>
        <p class="text-muted small">Send a manual payment for additional services or fees. Funds are deducted from your wallet immediately.</p>
        <form method="post" class="mt-3">
          {% csrf_token %}
          <input type="hidden" name="action" value="pay-jobflick">
          <div class="form-group mb-3">
            <label class="form-label">Amount (BDT)</label>
            {{ payment_form.amount }}
            {% if payment_form.amount.errors %}
              <small class="text-danger d-block">{{ payment_form.amount.errors|join:", " }}</small>
            {% endif %}
          </div>
          <div class="form-group mb-3">
            <label class="form-label">Note</label>
            {{ payment_form.note }}
            {% if payment_form.note.errors %}
              <small class="text-danger d-block">{{ payment_form.note.errors|join:", " }}</small>
            {% endif %}
          </div>
          <button class="btn btn-primary w-100" type="submit">Pay Now</button>
        </form>
      </div>
    </div>
  </div>
  <div class="col-lg-6 mb-4">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <h5 class="card-title">Request Payout</h5>
        <p class="text-muted small">Let the Jobflick finance team know how much you need to withdraw. We will review and credit the amount to your wallet once completed.</p>
        <form method="post" class="mt-3">
          {% csrf_token %}
          <input type="hidden" name="action" value="request-payout">
          <div class="form-group mb-3">
            <label class="form-label">Amount (BDT)</label>
            {{ payout_form.amount }}
            {% if payout_form.amount.errors %}
              <small class="text-danger d-block">{{ payout_form.amount.errors|join:", " }}</small>
            {% endif %}
          </div>
          <div class="form-group mb-3">
            <label class="form-label">Instructions / Reference</label>
            {{ payout_form.note }}
            {% if payout_form.note.errors %}
              <small class="text-danger d-block">{{ payout_form.note.errors|join:", " }}</small>
            {% endif %}
          </div>
          <button class="btn btn-outline-primary w-100" type="submit">Submit Request</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm border-0">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h4 class="mb-0">Transaction History</h4>
        <small class="text-muted">All wallet movements between you and Jobflick.</small>
      </div>
    </div>
    <div class="table-responsive">
      <table class="table align-middle">
        <thead class="table-light">
          <tr>
            <th>Reference</th>
            <th>Type</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Created</th>
            <th>Processed</th>
            <th class="text-end">Details</th>
          </tr>
        </thead>
        <tbody>
          {% for txn in transactions %}
          <tr>
            <td><strong>{{ txn.reference }}</strong></td>
            <td>
              {% if txn.direction == 'user_to_jobflick' %}
                <span class="badge badge-light text-danger">Paid to Jobflick</span>
              {% else %}
                <span class="badge badge-success">Paid to You</span>
              {% endif %}
              {% if txn.category %}
                <div class="text-muted small">{{ txn.get_category_display }}</div>
              {% endif %}
            </td>
            <td>
              {% if txn.direction == 'user_to_jobflick' %}-{% else %}+{% endif %}
              {{ txn.amount|intcomma }} BDT
              {% if txn.balance_after is not None %}
                <div class="text-muted small">Balance: {{ txn.balance_after|intcomma }} BDT</div>
              {% endif %}
            </td>
            <td>
              {% if txn.status == 'completed' %}
                <span class="badge badge-success">Completed</span>
              {% elif txn.status == 'pending' %}
                <span class="badge badge-warning text-dark">Pending</span>
              {% elif txn.status == 'processing' %}
                <span class="badge badge-info">Processing</span>
              {% else %}
                <span class="badge badge-danger">Failed</span>
              {% endif %}
            </td>
            <td>{{ txn.created_at|date:"M d, Y h:i A" }}</td>
            <td>
              {% if txn.processed_at %}
                {{ txn.processed_at|date:"M d, Y h:i A" }}
              {% else %}
                <span class="text-muted">â€”</span>
              {% endif %}
            </td>
            <td class="text-end">
              {% if txn.note %}
                <span class="d-block">{{ txn.note }}</span>
              {% else %}
                <span class="text-muted small">No note</span>
              {% endif %}
              {% if txn.job %}
                <small class="text-muted">Job: {{ txn.job.work_title }}</small>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="text-center text-muted">No transactions recorded yet.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
