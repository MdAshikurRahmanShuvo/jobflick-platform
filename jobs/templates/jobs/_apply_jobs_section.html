{% comment %}Shared Apply Jobs section used on job_list and homepage{% endcomment %}
{% if show_heading|default:True %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="h4 mb-0">Open Roles</h2>
    {% if request.user.is_authenticated %}
      {% if apply_profile.has_active_subscription %}
        <a class="btn btn-primary btn-sm" href="{% url 'post_job' %}">Post a Job</a>
      {% else %}
        <a class="btn btn-outline-primary btn-sm" href="{% url 'userprofile-subscription' %}">Activate Subscription</a>
      {% endif %}
    {% else %}
      <a class="btn btn-outline-primary btn-sm" href="{% url 'login' %}?next={% url 'job_list' %}">Sign in to continue</a>
    {% endif %}
  </div>
{% endif %}
{% if show_subscription_alerts|default:True %}
  {% if request.user.is_authenticated %}
    {% if not apply_profile.has_active_subscription %}
      <div class="alert alert-warning" role="alert">
        You can browse roles, but posting or applying requires an active subscription. Use your wallet balance of {{ apply_profile.wallet_balance }} BDT to purchase a plan.
        <a class="ml-2" href="{% url 'userprofile-subscription' %}">View plans</a>.
      </div>
    {% endif %}
  {% else %}
    <div class="alert alert-info" role="alert">
      Sign in to apply, track status, or activate a subscription. You'll be redirected back to this list instantly.
    </div>
  {% endif %}
{% endif %}
{% if jobs %}
  <div class="row">
    {% for job in jobs %}
    {% with application=job.app_for_user|first %}
    <div class="col-md-6 mb-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <h5 class="card-title mb-0">{{ job.work_title }}</h5>
            <span class="badge badge-light text-dark">{{ job.tracking_code }}</span>
          </div>
          {% if job.is_filled %}
            <div class="mb-2"><span class="badge badge-dark">Hiring completed</span></div>
          {% endif %}
          <p class="text-muted small mb-1"><strong>Worker Type:</strong> {{ job.worker_type }}</p>
          <p class="text-muted small mb-1"><strong>Duration:</strong> {{ job.duration }}</p>
          <p class="text-muted small mb-1"><strong>Budget:</strong> {{ job.amount }} BDT</p>
          <p class="text-muted small mb-1"><strong>Location:</strong> {{ job.location }}</p>
          <p class="text-muted small mb-0"><strong>Skills:</strong> {{ job.skills }}</p>
        </div>
        <div class="card-footer bg-white d-flex justify-content-between align-items-center">
          <div class="small text-muted">
            <div>Posted {{ job.created_at|timesince }} ago</div>
            <div>by {{ job.poster.username }}</div>
          </div>
          <div>
            {% if job.poster_id == request.user.id %}
              <span class="badge badge-secondary">You posted this</span>
              {% if job.is_filled %}
                <span class="badge badge-dark ml-1">Hiring completed</span>
              {% endif %}
            {% elif job.is_filled %}
              <span class="badge badge-dark">Hiring completed</span>
            {% elif application %}
              {% if application.status == 'approved' %}
                <span class="badge badge-success">Approved</span>
              {% elif application.status == 'pending' %}
                <span class="badge badge-warning text-dark">Pending</span>
              {% else %}
                <span class="badge badge-danger">Rejected</span>
              {% endif %}
            {% else %}
              {% if request.user.is_authenticated %}
                {% if apply_profile.has_active_subscription %}
                  <form method="post" action="{% url 'apply_to_job' job.id %}">
                    {% csrf_token %}
                    <input type="hidden" name="redirect_to" value="{{ apply_redirect_path|default:request.path }}">
                    <button class="btn btn-outline-primary btn-sm" type="submit">Apply</button>
                  </form>
                {% else %}
                  <a class="btn btn-outline-secondary btn-sm" href="{% url 'userprofile-subscription' %}">Subscribe to Apply</a>
                {% endif %}
              {% else %}
                <a class="btn btn-outline-primary btn-sm" href="{% url 'login' %}?next={% url 'job_list' %}">Sign in to Apply</a>
              {% endif %}
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% endwith %}
    {% endfor %}
  </div>
{% else %}
  <div class="text-center py-5 bg-light rounded">
    <h5 class="mb-2">No job posted yet</h5>
    <p class="text-muted">Be the first to create an opportunity.</p>
  </div>
{% endif %}
